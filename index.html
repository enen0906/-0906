<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>⭐大學星生活⭐刮刮卡</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            background: #fafafa;
            font-family: sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
        }

        h1 {
            font-size: 42px;
            color: #ff4500;
            font-weight: bold;
            margin: 20px 0;
            text-shadow: 1px 1px 2px #a00;
        }

        #scratch-card-container {
            position: relative;
            width: 90vw;
            max-width: 500px;
            aspect-ratio: 1080 / 1350;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        #prize-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }

        #scratch-mask {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #999;
            background-image: linear-gradient(135deg, #bbb 25%, #999 25%, #999 50%, #bbb 50%, #bbb 75%, #999 75%, #999 100%);
            background-size: 8px 8px;
            cursor: pointer;
            transition: opacity 0.3s ease-in-out;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 2em;
            color: white;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
            font-weight: bold;
        }

        #result {
            margin-top: 25px;
            text-align: center;
        }

        #result .prize-text {
            font-size: 48px;
            font-weight: 700;
            color: #c00;
        }

        #result .notice {
            font-size: 32px;
            color: #e60000;
            font-weight: 700;
        }

        .loading-text {
            font-size: 24px;
            color: #555;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% { opacity: 0.5; }
            50% { opacity: 1; }
            100% { opacity: 0.5; }
        }
    </style>
</head>
<body>
    <h1>⭐大學星生活⭐</h1>
    <div id="scratch-card-container">
        <img id="prize-image" src="https://i.ibb.co/2d1rP3W/BG.png" alt="刮刮卡背景" />
        <div id="scratch-mask">點我刮開</div>
    </div>
    <div id="result"></div>

    <script>
        // 在這裡設定你的 LIFF ID 和 Google Apps Script 部署後的 URL
        const LIFF_ID = '2007597530-o1xaVbZm';
        const GAS_URL = 'https://script.google.com/macros/s/AKfycbz9nfhw-DxaLUeSyMnmdvF02SjtlOLwccZ8--F-zqCgGJyCV4AYIe8fiUf0Vt1-tv/exec';

        let hasSentData = false;
        let isScratching = false;

        const container = document.getElementById('scratch-card-container');
        const mask = document.getElementById('scratch-mask');
        const prizeImage = document.getElementById('prize-image');
        const resultDiv = document.getElementById('result');
        let userId = '未知';

        // 裝置資訊
        let deviceBrand = '未知';
        let deviceModel = '未知';

        // 型號對照表 (與之前的程式碼相同)
        const modelMap = {
            "SM-G9800": "Galaxy S20", "SM-G9860": "Galaxy S20+", "SM-G9880": "Galaxy S20 Ultra",
            "IPHONE": "Apple iPhone（型號未知）", "PIXEL 7": "Google Pixel 7"
        };
        function guessModelName(rawModel) {
            if (!rawModel) return rawModel || "未知機型";
            const key = rawModel.toUpperCase();
            if (modelMap[key]) return modelMap[key];
            if (key.includes("IPHONE")) return "Apple iPhone";
            return rawModel;
        }
        function detectBrand(modelCode) {
            const code = modelCode.toUpperCase();
            if (code.startsWith("SM-")) return "Samsung";
            if (code.includes("IPHONE")) return "Apple";
            return "Android";
        }
        function getAndroidModel(ua) {
            const regex = /android.*;\s([^;]+)\sbuild/i;
            let match = ua.match(regex);
            if (match && match[1]) return match[1].trim();
            const regex2 = /android.*;\s([^;]+)\)/i;
            match = ua.match(regex2);
            if (match && match[1]) return match[1].trim();
            return "Android裝置";
        }
        function getDeviceInfo() {
            const ua = navigator.userAgent;
            if (ua.includes("iPhone")) { deviceBrand = "Apple"; deviceModel = "iPhone"; }
            else if (ua.includes("Android")) { const rawModel = getAndroidModel(ua); deviceModel = guessModelName(rawModel); deviceBrand = detectBrand(rawModel); }
        }

        function startApp() {
            console.log('LIFF 初始化成功，開始應用程式...');
            setupEventListeners();
        }

        // 初始化 LIFF
        async function initLiff() {
            try {
                await liff.init({ liffId: LIFF_ID });
                if (!liff.isLoggedIn()) {
                    liff.login();
                } else {
                    const profile = await liff.getProfile();
                    userId = profile.userId || '未知';
                    getDeviceInfo();
                    startApp();
                }
            } catch (err) {
                console.error('LIFF 初始化失敗', err);
                resultDiv.innerHTML = '<div class="notice">LIFF 初始化失敗，請確認 LIFF ID。</div>';
            }
        }

        // 向 Google Apps Script 傳送抽獎資料
        async function sendData() {
            if (hasSentData) return;
            hasSentData = true;

            resultDiv.innerHTML = '<div class="loading-text">正在確認中獎...</div>';
            mask.textContent = '中獎確認中...';

            const params = new URLSearchParams({
                action: 'draw',
                deviceBrand,
                deviceModel,
                userId,
                timestamp: new Date().toISOString()
            });

            try {
                const res = await fetch(`${GAS_URL}?${params.toString()}`);
                const data = await res.json();
                console.log('GAS 回應:', data);

                if (data.hasDrawn) {
                    resultDiv.innerHTML = `<div class="notice">你已經刮過囉！</div>`;
                    // 為了避免重複顯示，這裡可以選擇不替換圖片，或者用一個預設的「已刮過」圖片
                    prizeImage.src = 'https://i.ibb.co/2d1rP3W/BG.png';
                    mask.style.opacity = '0';
                    mask.style.display = 'none';
                } else {
                    const prize = data.prize;
                    const images = {
                        '天選獎S1': 'https://i.ibb.co/L5hY52B/S1-prize.jpg',
                        '天選獎S2': 'https://i.ibb.co/6PzL2nF/S2-prize.jpg',
                        '機會獎': 'https://i.ibb.co/6Pq931P/A.png',
                        '命運獎': 'https://i.ibb.co/YyLgT7c/B.png'
                    };

                    const imgUrl = images[prize] || 'https://placehold.co/1080x1350/999999/FFFFFF?text=錯誤';
                    
                    // 替換背景圖片並移除遮罩
                    prizeImage.src = imgUrl;
                    mask.style.opacity = '0';
                    mask.style.display = 'none';
                    resultDiv.innerHTML = `<div class="prize-text">🎉 恭喜你中了【${prize}】 🎉</div><div class="notice">請洽服務人員兌獎</div>`;
                }
            } catch (err) {
                console.error('資料送出失敗', err);
                resultDiv.innerHTML = '<div class="notice">資料送出失敗，請再試一次。</div>';
                mask.style.opacity = '1';
                mask.textContent = '點我刮開';
                hasSentData = false;
            }
        }

        // 刮刮卡互動邏輯
        function scratch(e) {
            if (hasSentData) return;
            e.preventDefault();
            
            // 由於沒有 Canvas，我們直接隱藏遮罩
            mask.style.opacity = '0';
            sendData();
            isScratching = false; // 刮一次後就停止
        }

        function setupEventListeners() {
            mask.addEventListener('mousedown', () => { isScratching = true; });
            mask.addEventListener('mouseup', () => { isScratching = false; });
            mask.addEventListener('mousemove', scratch);

            mask.addEventListener('touchstart', () => { isScratching = true; }, { passive: false });
            mask.addEventListener('touchend', () => { isScratching = false; });
            mask.addEventListener('touchmove', scratch, { passive: false });
        }

        window.addEventListener('DOMContentLoaded', () => {
            initLiff();
        });
    </script>
</body>
</html>
