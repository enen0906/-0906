<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>ğŸŒŸå¤§å­¸æ˜Ÿç”Ÿæ´»ğŸŒŸåˆ®åˆ®å¡</title>
<style>
  body { margin:0; padding:0; font-family:Arial,sans-serif; background:#f8f8f8; text-align:center; }
  h1 { margin:15px 0; color:#333; font-size:clamp(20px,5vw,32px); }
  #wrapper { position:relative; display:inline-block; width:95vw; max-width:400px; margin:auto; }
  canvas { border:2px solid #ccc; border-radius:12px; display:block; width:100%; height:auto; }
  #result { margin-top:15px; font-size:clamp(16px,4vw,22px); color:#333; font-weight:bold; display:none; }
  .prize { font-size:clamp(24px,6vw,40px); font-weight:700; color:#c00; margin-bottom:6px; white-space:nowrap; }
  .notice { font-size:clamp(14px,3.5vw,18px); color:#e60000; font-weight:500; }
</style>
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
</head>
<body>
<h1>ğŸŒŸå¤§å­¸æ˜Ÿç”Ÿæ´»ğŸŒŸ</h1>
<div id="wrapper">
  <canvas id="bgCanvas"></canvas>
  <canvas id="maskCanvas" style="position:absolute;top:0;left:0;"></canvas>
</div>
<div id="result"></div>

<script>
// ===== å‹è™Ÿå°ç…§è¡¨ =====
const modelMap = { /* èˆŠæœ‰ modelMap ä¸è®Š */ };

// ===== å‹è™Ÿåµæ¸¬å‡½æ•¸ =====
function guessModelName(rawModel){ /* èˆŠæœ‰å‡½æ•¸ */ }
function detectBrand(modelCode){ /* èˆŠæœ‰å‡½æ•¸ */ }
function getAndroidModel(ua){ /* èˆŠæœ‰å‡½æ•¸ */ }
function getDeviceInfo(){ /* èˆŠæœ‰å‡½æ•¸ */ }

// ===== Firebase è¨­å®š =====
const firebaseConfig = { /* èˆŠæœ‰ firebaseConfig */ };
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// ===== LIFF è¨­å®š =====
const LIFF_ID = '2007597530-o1xaVbZm';

// ===== DOM =====
const wrapper=document.getElementById('wrapper');
const bgCanvas=document.getElementById('bgCanvas');
const maskCanvas=document.getElementById('maskCanvas');
const bgCtx=bgCanvas.getContext('2d');
const maskCtx=maskCanvas.getContext('2d');
const resultDiv=document.getElementById('result');

let deviceBrand='æœªçŸ¥';
let deviceModel='æœªçŸ¥';
let userId='æœªçŸ¥';
let prize='';
let repeated=false;
let singleDraw=false;
let revealed=false; // ç”¨ä¾†æ§åˆ¶ç¬¬ä¸€æ¬¡åˆ®å®Œæ‰é¡¯ç¤º

// ===== åœ–ç‰‡è¨­å®š =====
const images={
  'å¤©é¸çS1':'https://i.postimg.cc/RCGKq4nk/6.png',
  'å¤©é¸çS2':'https://i.postimg.cc/gkxjRNkf/5.png',
  'æ©Ÿæœƒç':'https://i.postimg.cc/3xpwfNG1/3.png',
  'å‘½é‹ç':'https://i.postimg.cc/RFCV0TDp/2.png'
};

// ===== é¡¯ç¤ºçµæœ =====
function showResult(prizeText,repeatedFlag=false){
  if(repeatedFlag){
    resultDiv.innerHTML=`<div class="prize">å·²æŠ½é ğŸ‰ ${prizeText} ğŸ‰</div>
      <div class="notice">è«‹æ´½æœå‹™äººå“¡å…Œç</div>`;
  } else if(revealed){
    resultDiv.innerHTML=`<div class="prize">æ­å–œæŠ½ä¸­ğŸ‰ ${prizeText} ğŸ‰</div>
      <div class="notice">è«‹æ´½æœå‹™äººå“¡å…Œç</div>`;
  }
  resultDiv.style.display='block';
}

// ===== ç•«å¸ƒè¨­å®š =====
function setCanvasSize(){
  const width=wrapper.clientWidth;
  const height=Math.floor(width*1350/1080);
  wrapper.style.height=height+'px';
  bgCanvas.width=maskCanvas.width=width;
  bgCanvas.height=maskCanvas.height=height;
}

// ===== é®ç½©åˆå§‹åŒ– =====
function initMask(){
  maskCtx.clearRect(0,0,maskCanvas.width,maskCanvas.height);
  maskCtx.fillStyle='#999';
  maskCtx.fillRect(0,0,maskCanvas.width,maskCanvas.height);
  maskCanvas.style.pointerEvents='auto';
}

// ===== åˆ®åˆ®å¡ =====
let isDrawing=false;
function getPos(e){
  const rect=maskCanvas.getBoundingClientRect();
  if(e.touches && e.touches.length>0) return {x:e.touches[0].clientX-rect.left, y:e.touches[0].clientY-rect.top};
  else return {x:e.clientX-rect.left, y:e.clientY-rect.top};
}

function scratch(e){
  if(!isDrawing) return;
  e.preventDefault();
  const {x,y}=getPos(e);
  maskCtx.globalCompositeOperation='destination-out';
  maskCtx.beginPath();
  maskCtx.arc(x,y,50,0,Math.PI*2);
  maskCtx.fill();
}

function checkScratchPercent(){
  if(repeated) return; // é‡è¤‡æŠ½ä¸éœ€è¦æª¢æŸ¥
  const imgData=maskCtx.getImageData(0,0,maskCanvas.width,maskCanvas.height).data;
  let cleared=0;
  for(let i=3;i<imgData.length;i+=4) if(imgData[i]===0) cleared++;
  if(cleared/(maskCanvas.width*maskCanvas.height) > 0.5 && !revealed){
    revealed=true;
    showResult(prize,false);
    maskCanvas.style.pointerEvents='none';
  }
}

// ===== ç¶å®šäº‹ä»¶ =====
maskCanvas.addEventListener('mousedown',e=>{isDrawing=true;scratch(e);});
maskCanvas.addEventListener('mousemove',scratch);
maskCanvas.addEventListener('mouseup',()=>{isDrawing=false; checkScratchPercent();});
maskCanvas.addEventListener('mouseleave',()=>{isDrawing=false;});
maskCanvas.addEventListener('touchstart',e=>{isDrawing=true;scratch(e);},{passive:false});
maskCanvas.addEventListener('touchmove',scratch,{passive:false});
maskCanvas.addEventListener('touchend',()=>{isDrawing=false; checkScratchPercent();});

// ===== æŠ½ç =====
async function drawLottery(){
  try{
    if(singleDraw){
      const recordSnap=await db.ref('lottery-records/'+userId).get();
      if(recordSnap.exists()){
        prize=recordSnap.val().prize;
        repeated=true;
        revealed=true; // å·²æŠ½éç›´æ¥é¡¯ç¤º
        showResult(prize,true);
        maskCanvas.style.pointerEvents='none';
        return;
      }
    }

    repeated=false;

    const quotasSnap=await db.ref('lottery-quotas').get();
    const quotas=quotasSnap.val();

    let candidates=[];
    if(Math.random()<1/303 && quotas['å¤©é¸çS1']>0) candidates.push('å¤©é¸çS1');
    if(Math.random()<1/303 && quotas['å¤©é¸çS2']>0) candidates.push('å¤©é¸çS2');
    if(quotas['æ©Ÿæœƒç']>0) candidates.push('æ©Ÿæœƒç');
    if(quotas['å‘½é‹ç']>0) candidates.push('å‘½é‹ç');

    if(candidates.length===0){
      for(const key of ['å¤©é¸çS1','å¤©é¸çS2','æ©Ÿæœƒç','å‘½é‹ç']){
        if(quotas[key]>0) candidates.push(key);
      }
    }

    prize=candidates[Math.floor(Math.random()*candidates.length)];

    // è¼‰å…¥åœ–ç‰‡
    img.src=images[prize];

    await db.ref('lottery-records/'+userId).set({
      userId:userId,
      prize:prize,
      deviceBrand:deviceBrand,
      deviceModel:deviceModel,
      timestamp:new Date().toISOString()
    });
    await db.ref('lottery-quotas/'+prize).transaction(current=>{ return (current||0)-1; });

  }catch(e){ console.error(e); }
}

// ===== è¼‰å…¥åœ–ç‰‡ =====
const img=new Image();
img.crossOrigin='anonymous';
img.onload=()=>{
  setCanvasSize();
  bgCtx.drawImage(img,0,0,bgCanvas.width,bgCanvas.height);
  initMask();
};
window.addEventListener('resize',()=>{
  setCanvasSize();
  bgCtx.drawImage(img,0,0,bgCanvas.width,bgCanvas.height);
  // resize ä¸é‡ç½®é®ç½©
});

// ===== LIFF åˆå§‹åŒ– =====
async function initLiff(){
  await liff.init({liffId:LIFF_ID});
  if(!liff.isLoggedIn()) liff.login();
  else{
    try{
      const profile=await liff.getProfile();
      userId=profile.userId||'æœªçŸ¥';
    }catch(err){console.error('ç„¡æ³•å–å¾—ä½¿ç”¨è€…ID',err);}
    getDeviceInfo();

    try{
      const snapshot=await db.ref('settings/singleDraw').get();
      if(snapshot.exists()) singleDraw=snapshot.val()===true;
    }catch(e){console.error('è®€å–è¨­å®šå¤±æ•—',e);}

    await drawLottery();
  }
}

initLiff();
</script>
</body>
</html>
