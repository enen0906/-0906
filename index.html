<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>🌟大學星生活🌟刮刮卡</title>
<style>
  body { margin:0; padding:0; font-family:Arial,sans-serif; background:#f8f8f8; text-align:center; }
  h1 { margin:15px 0; color:#333; font-size:clamp(20px,5vw,32px); }
  #wrapper { position:relative; display:inline-block; width:95vw; max-width:400px; margin:auto; }
  canvas { border:2px solid #ccc; border-radius:12px; display:block; width:100%; height:auto; }
  #result { margin-top:15px; font-size:clamp(16px,4vw,22px); color:#333; font-weight:bold; display:none; }
  .prize { font-size:clamp(24px,6vw,40px); font-weight:700; color:#c00; margin-bottom:6px; white-space:nowrap; }
  .notice { font-size:clamp(14px,3.5vw,18px); color:#e60000; font-weight:500; }
</style>

<!-- LIFF SDK -->
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
</head>
<body>
<h1>🌟大學星生活🌟</h1>
<div id="wrapper">
  <canvas id="bgCanvas"></canvas>
  <canvas id="maskCanvas" style="position:absolute;top:0;left:0;"></canvas>
</div>
<div id="result"></div>

<script>
// ====== Firebase 設定 ======
const firebaseConfig = {
  apiKey: "YOUR_API_KEY",
  authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
  databaseURL: "https://guaguaca-b97ad-default-rtdb.asia-southeast1.firebasedatabase.app/",
  projectId: "YOUR_PROJECT_ID",
  storageBucket: "YOUR_PROJECT_ID.appspot.com",
  messagingSenderId: "YOUR_SENDER_ID",
  appId: "YOUR_APP_ID"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// ====== LIFF 設定 ======
const LIFF_ID = '2007597530-o1xaVbZm';

// ====== DOM ======
const wrapper = document.getElementById('wrapper');
const bgCanvas = document.getElementById('bgCanvas');
const maskCanvas = document.getElementById('maskCanvas');
const bgCtx = bgCanvas.getContext('2d');
const maskCtx = maskCanvas.getContext('2d');
const resultDiv = document.getElementById('result');

let deviceBrand = '未知';
let deviceModel = '未知';
let userId = '未知';
let prize = '';
let singleDraw = false; // 後台控制

const images = {
  '天選獎S1':'https://i.postimg.cc/RCGKq4nk/6.png',
  '天選獎S2':'https://i.postimg.cc/gkxjRNkf/5.png',
  '機會獎':'https://i.postimg.cc/3xpwfNG1/3.png',
  '命運獎':'https://i.postimg.cc/RFCV0TDp/2.png'
};

// ====== 型號偵測 ======
function getDeviceInfo(){
  const ua=navigator.userAgent.toLowerCase();
  if(ua.includes('iphone')){ deviceBrand='Apple'; deviceModel='iPhone'; }
  else if(ua.includes('ipad')){ deviceBrand='Apple'; deviceModel='iPad'; }
  else if(ua.includes('android')){ deviceBrand='Android'; deviceModel='Android裝置'; }
  else{ deviceBrand='未知'; deviceModel='未知'; }
}

// ====== 讀取後台開關 ======
async function fetchSettings() {
  try {
    const settingsRef = db.ref('settings/singleDraw');
    const snapshot = await settingsRef.get();
    if(snapshot.exists()){
      singleDraw = snapshot.val();
    }
  } catch(e) {
    console.error('讀取後台開關失敗', e);
  }
}

// ====== LIFF 初始化 ======
async function initLiff(){
  await liff.init({liffId:LIFF_ID});
  if(!liff.isLoggedIn()) liff.login();
  else{
    try{ 
      const profile=await liff.getProfile(); 
      userId=profile.userId||'未知'; 
    } catch(err){ console.error('無法取得使用者ID',err);}
    getDeviceInfo();
    await fetchSettings(); // 先讀後台開關
    await drawLottery();
  }
}

// ====== 抽獎邏輯 ======
async function drawLottery(){
  try {
    if(singleDraw){
      const recordRef = db.ref(`lottery-records/${userId}`);
      const snapshot = await recordRef.get();
      if(snapshot.exists()){
        prize = snapshot.val().prize;
        showResult(prize, true); // 已抽過
        return;
      }
    }

    // ===== 抽獎 =====
    const quotasRef = db.ref('lottery-quotas');
    const quotasSnap = await quotasRef.get();
    const quotas = quotasSnap.val();

    const rand = Math.random();
    if(rand < 1/303 && quotas['天選獎S1']>0) prize='天選獎S1';
    else if(rand < 1/303 && quotas['天選獎S2']>0) prize='天選獎S2';
    else {
      let normal = [];
      if(quotas['機會獎']>0) normal.push('機會獎');
      if(quotas['命運獎']>0) normal.push('命運獎');
      prize = normal[Math.floor(Math.random()*normal.length)];
    }

    const quotaRef = db.ref('lottery-quotas/' + prize);
    quotaRef.transaction(current => (current||0)>0 ? current-1 : 0);

    const statRef = db.ref(`lottery-stats/${deviceBrand}/${deviceModel}`);
    statRef.transaction(current => (current||0)+1);

    if(singleDraw){
      const recordRef = db.ref(`lottery-records/${userId}`);
      recordRef.set({ prize, timestamp: Date.now() });
    }

    img.src = images[prize];

  } catch(e) {
    console.error('抽獎失敗', e);
    prize='機會獎';
    img.src = images[prize];
  }
}

// ====== 畫布設定 ======
function setCanvasSize(){
  const width = wrapper.clientWidth;
  const height = Math.floor(width*1350/1080);
  wrapper.style.height = height+'px';
  bgCanvas.width = maskCanvas.width = width;
  bgCanvas.height = maskCanvas.height = height;
}

function initMask(){
  maskCtx.fillStyle='#999';
  maskCtx.fillRect(0,0,maskCanvas.width,maskCanvas.height);
}

// ====== 刮刮卡 ======
let isDrawing=false;
function getPos(e){
  const rect=maskCanvas.getBoundingClientRect();
  if(e.touches && e.touches.length>0) return {x:e.touches[0].clientX-rect.left, y:e.touches[0].clientY-rect.top};
  else return {x:e.clientX-rect.left, y:e.clientY-rect.top};
}

function scratch(e){
  if(!isDrawing) return;
  e.preventDefault();
  const {x,y}=getPos(e);
  maskCtx.globalCompositeOperation='destination-out';
  maskCtx.beginPath();
  maskCtx.arc(x,y,50,0,Math.PI*2);
  maskCtx.fill();
}

function checkScratchPercent(){
  const imgData=maskCtx.getImageData(0,0,maskCanvas.width,maskCanvas.height).data;
  let cleared=0;
  for(let i=3;i<imgData.length;i+=4) if(imgData[i]===0) cleared++;
  if(cleared/(maskCanvas.width*maskCanvas.height) > 0.5) showResult(prize);
}

function showResult(prizeText, already=false){
  const notice = already ? "你已經抽過囉！" : "請洽服務人員兌獎";
  resultDiv.innerHTML = `<div class="prize">🎉 ${already ? "已抽過" : "恭喜你"}：${prizeText} 🎉</div>
    <div class="notice">${notice}</div>`;
  resultDiv.style.display='block';
  maskCanvas.style.pointerEvents='none'; // 停止刮
}

// ====== 綁定事件 ======
maskCanvas.addEventListener('mousedown',e=>{isDrawing=true;scratch(e);});
maskCanvas.addEventListener('mousemove',scratch);
maskCanvas.addEventListener('mouseup',()=>{isDrawing=false; checkScratchPercent();});
maskCanvas.addEventListener('mouseleave',()=>{isDrawing=false;});
maskCanvas.addEventListener('touchstart',e=>{isDrawing=true;scratch(e);},{passive:false});
maskCanvas.addEventListener('touchmove',scratch,{passive:false});
maskCanvas.addEventListener('touchend',()=>{isDrawing=false; checkScratchPercent();});

// ====== 載入圖片 ======
const img=new Image();
img.crossOrigin='anonymous';
img.onload=()=>{
  setCanvasSize();
  bgCtx.drawImage(img,0,0,bgCanvas.width,bgCanvas.height);
  initMask();
};
window.addEventListener('resize',()=>{
  setCanvasSize();
  bgCtx.drawImage(img,0,0,bgCanvas.width,bgCanvas.height);
  initMask();
});

// ====== 初始化 ======
initLiff();
</script>
</body>
</html>
