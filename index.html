<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>â­å¤§å­¸æ˜Ÿç”Ÿæ´»â­åˆ®åˆ®å¡</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            background: #fafafa;
            font-family: sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
        }

        h1 {
            font-size: 42px;
            color: #ff4500;
            font-weight: bold;
            margin: 20px 0;
            text-shadow: 1px 1px 2px #a00;
        }

        #scratch-card-container {
            position: relative;
            width: 90vw;
            max-width: 500px;
            aspect-ratio: 1080 / 1350;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        #bgCanvas, #maskCanvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }
        
        #result {
            margin-top: 25px;
            text-align: center;
        }

        #result .prize-text {
            font-size: 48px;
            font-weight: 700;
            color: #c00;
        }

        #result .notice {
            font-size: 32px;
            color: #e60000;
            font-weight: 700;
        }

        .loading-text {
            font-size: 24px;
            color: #555;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% { opacity: 0.5; }
            50% { opacity: 1; }
            100% { opacity: 0.5; }
        }
    </style>
</head>
<body>
    <h1>â­å¤§å­¸æ˜Ÿç”Ÿæ´»â­</h1>
    <div id="scratch-card-container">
        <canvas id="bgCanvas"></canvas>
        <canvas id="maskCanvas"></canvas>
    </div>
    <div id="result"></div>

    <script>
        // åœ¨é€™è£¡è¨­å®šä½ çš„ LIFF ID å’Œ Google Apps Script éƒ¨ç½²å¾Œçš„ URL
        const LIFF_ID = '2007597530-o1xaVbZm';
        const GAS_URL = 'https://script.google.com/macros/s/AKfycbz9nfhw-DxaLUeSyMnmdvF02SjtlOLwccZ8--F-zqCgGJyCV4AYIe8fiUf0Vt1-tv/exec';

        let hasSentData = false;
        let isDrawing = false;
        let prize = '';

        const container = document.getElementById('scratch-card-container');
        const bgCanvas = document.getElementById('bgCanvas');
        const maskCanvas = document.getElementById('maskCanvas');
        const bgCtx = bgCanvas.getContext('2d');
        const maskCtx = maskCanvas.getContext('2d');
        const resultDiv = document.getElementById('result');
        let userId = 'æœªçŸ¥';

        // è£ç½®è³‡è¨Š
        let deviceBrand = 'æœªçŸ¥';
        let deviceModel = 'æœªçŸ¥';

        // å‹è™Ÿå°ç…§è¡¨ (å·²è£œé½Š)
        const modelMap = {
            "SM-G9800": "Samsung Galaxy S20",
            "SM-G9860": "Samsung Galaxy S20+",
            "SM-G9880": "Samsung Galaxy S20 Ultra",
            "SM-A515F": "Samsung Galaxy A51",
            "SM-N970F": "Samsung Galaxy Note 10",
            "SM-F700F": "Samsung Galaxy Z Flip",
            "IPHONE": "Apple iPhone (å‹è™ŸæœªçŸ¥)",
            "IPHONE 11,2": "Apple iPhone 11",
            "IPHONE 12,1": "Apple iPhone 11",
            "IPHONE 12,3": "Apple iPhone 11 Pro",
            "IPHONE 12,5": "Apple iPhone 11 Pro Max",
            "IPHONE 13,1": "Apple iPhone 12 mini",
            "IPHONE 13,2": "Apple iPhone 12",
            "IPHONE 13,3": "Apple iPhone 12 Pro",
            "IPHONE 13,4": "Apple iPhone 12 Pro Max",
            "IPHONE 14,2": "Apple iPhone 13 Pro",
            "IPHONE 14,3": "Apple iPhone 13 Pro Max",
            "IPHONE 14,4": "Apple iPhone 13 mini",
            "IPHONE 14,5": "Apple iPhone 13",
            "IPHONE 15,2": "Apple iPhone 14 Pro",
            "IPHONE 15,3": "Apple iPhone 14 Pro Max",
            "IPHONE 15,4": "Apple iPhone 14 Plus",
            "IPHONE 15,5": "Apple iPhone 14",
            "PIXEL 7": "Google Pixel 7",
            "PIXEL 7 PRO": "Google Pixel 7 Pro",
            "PIXEL 6": "Google Pixel 6",
            "PIXEL 6 PRO": "Google Pixel 6 Pro",
            "PIXEL 5": "Google Pixel 5",
            "ONEPLUS A6003": "OnePlus 6T",
            "M2102J20SG": "Xiaomi Redmi Note 10",
            "ASUS_Z01QD": "ASUS ROG Phone 2",
            "HUAWEI MATE 20": "Huawei Mate 20",
            "SONY G8342": "Sony Xperia XZ1"
        };
        function guessModelName(rawModel) {
            if (!rawModel) return rawModel || "æœªçŸ¥æ©Ÿå‹";
            const key = rawModel.toUpperCase();
            if (modelMap[key]) return modelMap[key];
            if (key.includes("IPHONE")) return "Apple iPhone";
            return rawModel;
        }
        function detectBrand(modelCode) {
            const code = modelCode.toUpperCase();
            if (code.startsWith("SM-") || code.includes("GALAXY")) return "Samsung";
            if (code.includes("IPHONE")) return "Apple";
            if (code.includes("PIXEL")) return "Google";
            if (code.includes("ONEPLUS")) return "OnePlus";
            if (code.includes("HUAWEI")) return "Huawei";
            if (code.includes("SONY")) return "Sony";
            if (code.includes("ASUS")) return "Asus";
            return "Android";
        }
        function getAndroidModel(ua) {
            const regex = /android.*;\s([^;]+)\sbuild/i;
            let match = ua.match(regex);
            if (match && match[1]) return match[1].trim();
            const regex2 = /android.*;\s([^;]+)\)/i;
            match = ua.match(regex2);
            if (match && match[1]) return match[1].trim();
            return "Androidè£ç½®";
        }
        function getDeviceInfo() {
            const ua = navigator.userAgent;
            if (ua.includes("iPhone")) { deviceBrand = "Apple"; deviceModel = guessModelName(ua); }
            else if (ua.includes("Android")) { const rawModel = getAndroidModel(ua); deviceModel = guessModelName(rawModel); deviceBrand = detectBrand(rawModel); }
            else { deviceBrand = "æœªçŸ¥"; deviceModel = "æœªçŸ¥"; }
        }
        
        function setCanvasSize() {
            const width = container.clientWidth;
            const height = Math.floor(width * 1350 / 1080);
            container.style.height = height + 'px';
            bgCanvas.width = maskCanvas.width = width;
            bgCanvas.height = maskCanvas.height = height;
        }

        function initMask() {
            maskCtx.fillStyle = '#999';
            maskCtx.fillRect(0, 0, maskCanvas.width, maskCanvas.height);
            maskCtx.globalCompositeOperation = 'destination-out';
        }

        function checkScratchPercent() {
            const imgData = maskCtx.getImageData(0, 0, maskCanvas.width, maskCanvas.height).data;
            let cleared = 0;
            for (let i = 3; i < imgData.length; i += 4) {
                if (imgData[i] === 0) cleared++;
            }
            const percent = cleared / (maskCanvas.width * maskCanvas.height) * 100;
            if (percent > 50) {
                resultDiv.innerHTML = `<div class="prize-text">ğŸ‰ æ­å–œä½ ä¸­äº†ã€${prize}ã€‘ ğŸ‰</div><div class="notice">è«‹æ´½æœå‹™äººå“¡å…Œç</div>`;
                maskCanvas.style.pointerEvents = 'none';
                sendData();
            }
        }

        function getPos(e) {
            const rect = maskCanvas.getBoundingClientRect();
            if (e.touches && e.touches.length > 0) {
                return {
                    x: e.touches[0].clientX - rect.left,
                    y: e.touches[0].clientY - rect.top
                };
            } else {
                return {
                    x: e.clientX - rect.left,
                    y: e.clientY - rect.top
                };
            }
        }
        
        function scratch(e) {
            if (!isDrawing) return;
            e.preventDefault();
            const { x, y } = getPos(e);
            maskCtx.beginPath();
            maskCtx.arc(x, y, 50, 0, Math.PI * 2);
            maskCtx.fill();
        }
        
        function setupEventListeners() {
            maskCanvas.addEventListener('mousedown', (e) => {
                isDrawing = true;
                scratch(e);
            });
            maskCanvas.addEventListener('mousemove', scratch);
            maskCanvas.addEventListener('mouseup', () => {
                isDrawing = false;
                checkScratchPercent();
            });
            maskCanvas.addEventListener('mouseleave', () => {
                isDrawing = false;
            });
            maskCanvas.addEventListener('touchstart', (e) => {
                isDrawing = true;
                scratch(e);
            }, { passive: false });
            maskCanvas.addEventListener('touchmove', scratch, { passive: false });
            maskCanvas.addEventListener('touchend', () => {
                isDrawing = false;
                checkScratchPercent();
            });
        }
        
        async function startApp() {
            console.log('LIFF åˆå§‹åŒ–æˆåŠŸï¼Œé–‹å§‹æ‡‰ç”¨ç¨‹å¼...');
            
            // æŠ½çé‚è¼¯ (èˆ‡ä¹‹å‰çš„ç¨‹å¼ç¢¼ç›¸åŒ)
            const rand = Math.random();
            if (rand < 4 / 303) {
                prize = Math.random() < 0.5 ? 'å¤©é¸çS1' : 'å¤©é¸çS2';
            } else if (rand < 4 / 303 + 0.5 * 299 / 303) {
                prize = 'æ©Ÿæœƒç';
            } else {
                prize = 'å‘½é‹ç';
            }

            const images = {
                'å¤©é¸çS1': 'https://i.ibb.co/6y4tW64/S1-prize.jpg',
                'å¤©é¸çS2': 'https://i.ibb.co/y4L2jCj/S2-prize.jpg',
                'æ©Ÿæœƒç': 'https://i.ibb.co/h93LqFv/A-prize.jpg',
                'å‘½é‹ç': 'https://i.ibb.co/8b76D1F/B-prize.jpg'
            };
            
            const img = new Image();
            img.crossOrigin = 'anonymous';
            img.src = images[prize];
            
            img.onload = () => {
                setCanvasSize();
                bgCtx.drawImage(img, 0, 0, bgCanvas.width, bgCanvas.height);
                initMask();
                setupEventListeners();
            };
            
            img.onerror = () => {
                console.error("Failed to load prize image.");
                bgCtx.fillStyle = '#f0f0f0';
                bgCtx.fillRect(0, 0, bgCanvas.width, bgCanvas.height);
                bgCtx.fillStyle = '#555';
                bgCtx.font = '30px Arial';
                bgCtx.textAlign = 'center';
                bgCtx.fillText('åœ–ç‰‡è¼‰å…¥å¤±æ•—', bgCanvas.width / 2, bgCanvas.height / 2);
                initMask();
                setupEventListeners();
            };

            window.addEventListener('resize', () => {
                setCanvasSize();
                bgCtx.drawImage(img, 0, 0, bgCanvas.width, bgCanvas.height);
                initMask();
            });
        }

        // åˆå§‹åŒ– LIFF
        async function initLiff() {
            try {
                await liff.init({ liffId: LIFF_ID });
                if (!liff.isLoggedIn()) {
                    liff.login();
                } else {
                    const profile = await liff.getProfile();
                    userId = profile.userId || 'æœªçŸ¥';
                    getDeviceInfo();
                    startApp();
                }
            } catch (err) {
                console.error('LIFF åˆå§‹åŒ–å¤±æ•—', err);
                resultDiv.innerHTML = '<div class="notice">LIFF åˆå§‹åŒ–å¤±æ•—ï¼Œè«‹ç¢ºèª LIFF IDã€‚</div>';
            }
        }
        
        // å‘ Google Apps Script å‚³é€æŠ½çè³‡æ–™
        async function sendData() {
            if (hasSentData) return;
            hasSentData = true;

            resultDiv.innerHTML = '<div class="loading-text">æ­£åœ¨ç¢ºèªä¸­ç...</div>';

            const params = new URLSearchParams({
                action: 'draw',
                prize,
                deviceBrand,
                deviceModel,
                userId,
                timestamp: new Date().toISOString()
            });

            try {
                const res = await fetch(`${GAS_URL}?${params.toString()}`);
                const data = await res.json();
                console.log('GAS å›æ‡‰:', data);

                if (data.hasDrawn) {
                    resultDiv.innerHTML = `<div class="notice">ä½ å·²ç¶“åˆ®éå›‰ï¼</div>`;
                }
            } catch (err) {
                console.error('è³‡æ–™é€å‡ºå¤±æ•—', err);
                resultDiv.innerHTML = '<div class="notice">è³‡æ–™é€å‡ºå¤±æ•—ï¼Œè«‹å†è©¦ä¸€æ¬¡ã€‚</div>';
                hasSentData = false;
            }
        }

        window.addEventListener('DOMContentLoaded', () => {
            initLiff();
        });
    </script>
</body>
</html>
