<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ğŸŒŸå¤§å­¸æ˜Ÿç”Ÿæ´»ğŸŒŸåˆ®åˆ®å¡</title>
  <style>
    body { margin:0; padding:0; font-family: Arial,sans-serif; background:#f8f8f8; text-align:center; }
    h1 { margin:15px 0; color:#333; font-size:clamp(20px,5vw,32px);}
    #wrapper { position:relative; display:inline-block; width:95vw; max-width:400px; margin:auto;}
    canvas { border:2px solid #ccc; border-radius:12px; display:block; width:100%; height:auto;}
    #result { margin-top:15px; font-size:clamp(16px,4vw,22px); color:#333; font-weight:bold; display:none;}
    .prize { font-size:clamp(24px,6vw,40px); font-weight:700; color:#c00; margin-bottom:6px; white-space:nowrap;}
    .notice { font-size:clamp(14px,3.5vw,18px); color:#e60000; font-weight:500;}
  </style>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</head>
<body>
  <h1>ğŸŒŸå¤§å­¸æ˜Ÿç”Ÿæ´»ğŸŒŸ</h1>
  <div id="wrapper">
    <canvas id="bgCanvas"></canvas>
    <canvas id="maskCanvas" style="position:absolute;top:0;left:0;"></canvas>
  </div>
  <div id="result">åˆ®é–‹çœ‹çœ‹ä½ çš„çé …ï¼</div>

  <script>
    const LIFF_ID = '2007597530-o1xaVbZm';
    const GAS_URL = 'https://script.google.com/macros/s/AKfycbz9nfhw-DxaLUeSyMnmdvF02SjtlOLwccZ8--bFr_zqCgGJyCV4AYIe8fiUf0Vt1-tv/exec';

    const wrapper = document.getElementById('wrapper');
    const bgCanvas = document.getElementById('bgCanvas');
    const maskCanvas = document.getElementById('maskCanvas');
    const bgCtx = bgCanvas.getContext('2d');
    const maskCtx = maskCanvas.getContext('2d');
    const resultDiv = document.getElementById('result');

    let userId = 'æœªçŸ¥';
    let deviceBrand = 'æœªçŸ¥';
    let deviceModel = 'æœªçŸ¥';
    let prize = '';
    let hasSentData = false;

    const modelMap = {
      /* é€™è£¡ä¿ç•™ä½ å‰é¢é‚£ä»½å®Œæ•´å‹è™Ÿå°ç…§è¡¨ */
    };

    function guessModelName(rawModel) {
      if (!rawModel) return "æœªçŸ¥æ©Ÿå‹";
      const key = rawModel.toUpperCase();
      return modelMap[key] || rawModel;
    }

    function detectBrand(modelCode) {
      const code = modelCode.toUpperCase();
      if (code.startsWith("SM-")) return "Samsung";
      if (code.includes("IPHONE")) return "Apple";
      if (code.includes("PIXEL")) return "Google";
      if (code.includes("ONEPLUS")) return "OnePlus";
      if (code.includes("OPPO")) return "OPPO";
      if (code.includes("ASUS")) return "ASUS";
      if (code.includes("VIVO")) return "vivo";
      if (code.includes("REALME")) return "realme";
      if (code.includes("XIAOMI") || code.includes("REDMI")) return "Xiaomi";
      return "Android";
    }

    function getAndroidModel(ua) {
      const regex = /android.*;\s([^;]+)\sbuild/i;
      let match = ua.match(regex);
      if (match && match[1]) return match[1].trim();
      return "Androidè£ç½®";
    }

    async function initLiff() {
      await liff.init({ liffId: LIFF_ID });
      if (!liff.isLoggedIn()) liff.login();
      else {
        try { const profile = await liff.getProfile(); userId = profile.userId || 'æœªçŸ¥'; } 
        catch(e){ console.error(e); }
        getDeviceInfo();
        checkDrawStatus();
      }
    }

    function getDeviceInfo() {
      const ua = navigator.userAgent.toLowerCase();
      if (ua.includes('iphone')) { deviceBrand='Apple'; deviceModel='iPhone'; }
      else if (ua.includes('ipad')) { deviceBrand='Apple'; deviceModel='iPad'; }
      else if (ua.includes('android')) {
        const rawModel = getAndroidModel(ua);
        const code = rawModel.toUpperCase();
        deviceModel = guessModelName(code);
        deviceBrand = detectBrand(code);
      }
    }

    async function checkDrawStatus() {
      const params = new URLSearchParams({ action:'check_draw', userId });
      const res = await fetch(`${GAS_URL}?${params.toString()}`);
      const data = await res.json();
      if (data.hasDrawn) {
        resultDiv.innerHTML = `<div class="notice">æ‚¨å·²æŠ½éçï¼Œç„¡æ³•é‡è¤‡æŠ½å–ï¼</div>`;
        resultDiv.style.display='block';
        maskCanvas.style.pointerEvents='none';
      } else {
        drawPrize();
      }
    }

    async function drawPrize() {
      const params = new URLSearchParams({ action:'draw_prize', userId });
      const res = await fetch(`${GAS_URL}?${params.toString()}`);
      const data = await res.json();
      if (data.error) {
        resultDiv.innerHTML = `<div class="notice">${data.error}</div>`;
        resultDiv.style.display='block';
        maskCanvas.style.pointerEvents='none';
        return;
      }
      prize = data.prize;
      loadPrizeImage(prize);
    }

    const images = {
      'å¤©é¸çS1':'https://i.postimg.cc/RCGKq4nk/6.png',
      'å¤©é¸çS2':'https://i.postimg.cc/gkxjRNkf/5.png',
      'æ©Ÿæœƒç':'https://i.postimg.cc/3xpwfNG1/3.png',
      'å‘½é‹ç':'https://i.postimg.cc/RFCV0TDp/2.png'
    };

    let img = new Image();
    img.crossOrigin='anonymous';
    function loadPrizeImage(prize) { 
      img.src = images[prize];
    }

    function setCanvasSize() {
      const width = wrapper.clientWidth;
      const height = Math.floor(width * 1350 / 1080);
      wrapper.style.height = height+'px';
      bgCanvas.width = maskCanvas.width = width;
      bgCanvas.height = maskCanvas.height = height;
    }

    function initMask() {
      maskCtx.fillStyle='#999';
      maskCtx.fillRect(0,0,maskCanvas.width,maskCanvas.height);
    }

    function checkScratchPercent() {
      const imgData = maskCtx.getImageData(0,0,maskCanvas.width,maskCanvas.height).data;
      let cleared=0;
      for(let i=3;i<imgData.length;i+=4) if(imgData[i]===0) cleared++;
      const percent = cleared/(maskCanvas.width*maskCanvas.height)*100;
      if(percent>50 && !hasSentData){
        resultDiv.innerHTML = `<div class="prize">ğŸ‰ æ­å–œä½ ä¸­äº†ã€${prize}ã€‘ ğŸ‰</div>
        <div class="notice">è«‹æ´½æœå‹™äººå“¡å…Œç</div>`;
        resultDiv.style.display='block';
        maskCanvas.style.pointerEvents='none';
        sendRecord(prize);
      }
    }

    function getPos(e){
      const rect = maskCanvas.getBoundingClientRect();
      if(e.touches && e.touches.length>0) return {x:e.touches[0].clientX-rect.left, y:e.touches[0].clientY-rect.top};
      return {x:e.clientX-rect.left, y:e.clientY-rect.top};
    }

    let isDrawing=false;
    function scratch(e){
      if(!isDrawing) return;
      e.preventDefault();
      const {x,y} = getPos(e);
      maskCtx.globalCompositeOperation='destination-out';
      maskCtx.beginPath();
      maskCtx.arc(x,y,50,0,Math.PI*2);
      maskCtx.fill();
    }

    maskCanvas.addEventListener('mousedown',()=>{isDrawing=true;});
    maskCanvas.addEventListener('mousemove',scratch);
    maskCanvas.addEventListener('mouseup',()=>{isDrawing=false; checkScratchPercent();});
    maskCanvas.addEventListener('mouseleave',()=>{isDrawing=false;});
    maskCanvas.addEventListener('touchstart',(e)=>{isDrawing=true; scratch(e);},{passive:false});
    maskCanvas.addEventListener('touchmove',scratch,{passive:false});
    maskCanvas.addEventListener('touchend',()=>{isDrawing=false; checkScratchPercent();});

    img.onload = ()=>{
      setCanvasSize();
      bgCtx.drawImage(img,0,0,bgCanvas.width,bgCanvas.height);
      initMask();
    };

    window.addEventListener('resize',()=>{
      setCanvasSize();
      bgCtx.drawImage(img,0,0,bgCanvas.width,bgCanvas.height);
      initMask();
    });

    async function sendRecord(prize){
      hasSentData=true;
      const params = new URLSearchParams({
        action:'record_win',
        userId, prize, deviceBrand, deviceModel
      });
      try {
        const res = await fetch(GAS_URL, {method:'POST', body: params});
        const data = await res.json();
        console.log('é€å‡ºè³‡æ–™:', data);
      } catch(e){ console.error('é€å‡ºå¤±æ•—', e);}
    }

    initLiff();
  </script>
</body>
</html>
