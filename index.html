<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>â­å¤§å­¸æ˜Ÿç”Ÿæ´»â­åˆ®åˆ®å¡</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        body {
            text-align: center;
            margin: 0;
            padding: 20px;
            font-family: sans-serif;
            background: #fafafa;
        }

        h1 {
            font-size: 42px;
            color: #ff4500;
            font-weight: bold;
            margin-bottom: 20px;
            text-shadow: 1px 1px 2px #a00;
        }

        #wrapper {
            position: relative;
            width: 90vw;
            max-width: 500px;
            margin: 0 auto;
            aspect-ratio: 1080/1350;
        }

        #wrapper canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border-radius: 12px;
            touch-action: none;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            transition: transform 0.3s ease-in-out;
        }

        #wrapper canvas:hover {
            transform: translateY(-5px);
        }

        #result {
            margin-top: 25px;
            text-align: center;
        }

        #result .prize {
            font-size: 48px;
            margin-bottom: 10px;
            font-weight: 700;
            color: #c00;
        }

        #result .notice {
            font-size: 32px;
            color: #e60000;
            font-weight: 700;
        }

        .loading-text {
            font-size: 24px;
            color: #555;
            margin-top: 20px;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% {
                opacity: 0.5;
            }
            50% {
                opacity: 1;
            }
            100% {
                opacity: 0.5;
            }
        }
    </style>
</head>
<body>
    <h1>â­å¤§å­¸æ˜Ÿç”Ÿæ´»â­</h1>
    <div id="wrapper">
        <canvas id="bgCanvas"></canvas>
        <canvas id="maskCanvas"></canvas>
    </div>
    <div id="result"></div>

    <script>
        const LIFF_ID = '2007597530-o1xaVbZm';
        const GAS_URL = 'https://script.google.com/macros/s/AKfycbz9nfhw-DxaLUeSyMnmdvF02SjtlOLwccZ8--bFr_zqCgGJyCV4AYIe8fiUf0Vt1-tv/exec';

        const wrapper = document.getElementById('wrapper');
        const bgCanvas = document.getElementById('bgCanvas');
        const maskCanvas = document.getElementById('maskCanvas');
        const bgCtx = bgCanvas.getContext('2d');
        const maskCtx = maskCanvas.getContext('2d');
        const resultDiv = document.getElementById('result');

        let deviceBrand = 'æœªçŸ¥';
        let deviceModel = 'æœªçŸ¥';
        let userId = 'æœªçŸ¥';
        let hasSentData = false;

        // å‹è™Ÿå°ç…§è¡¨
        const modelMap = {
            "SM-G9800": "Galaxy S20",
            "SM-G9860": "Galaxy S20+",
            "SM-G9880": "Galaxy S20 Ultra",
            "SM-G9910": "Galaxy S21",
            "SM-G9960": "Galaxy S21+",
            "SM-G9980": "Galaxy S21 Ultra",
            "SM-S9010": "Galaxy S22",
            "SM-S9060": "Galaxy S22+",
            "SM-S9080": "Galaxy S22 Ultra",
            "SM-S9110": "Galaxy S23",
            "SM-S9160": "Galaxy S23+",
            "SM-S9180": "Galaxy S23 Ultra",
            "SM-S9210": "Galaxy S24",
            "SM-S9260": "Galaxy S24+",
            "SM-S9280": "Galaxy S24 Ultra",
            "SM-S9310": "Galaxy S25",
            "SM-S9360": "Galaxy S25+",
            "SM-S9380": "Galaxy S25 Ultra",
            "SM-F7000": "Galaxy Z Flip",
            "SM-F9160": "Galaxy Z Fold2",
            "SM-F7110": "Galaxy Z Flip3",
            "SM-F9260": "Galaxy Z Fold3",
            "SM-F7210": "Galaxy Z Flip4",
            "SM-F9360": "Galaxy Z Fold4",
            "SM-F7310": "Galaxy Z Flip5",
            "SM-F9460": "Galaxy Z Fold5",
            "SM-F7410": "Galaxy Z Flip6",
            "SM-F9560": "Galaxy Z Fold6",
            "SM-A5150": "Galaxy A51",
            "SM-A7150": "Galaxy A71",
            "SM-A3250": "Galaxy A32",
            "SM-A5250": "Galaxy A52",
            "SM-A5260": "Galaxy A52 5G",
            "SM-A7250": "Galaxy A72",
            "SM-A2660": "Galaxy A26 5G",
            "SM-A3360": "Galaxy A33 5G",
            "SM-A3660": "Galaxy A36 5G",
            "SM-A5360": "Galaxy A53 5G",
            "SM-A5660": "Galaxy A56 5G",
            "SM-A7360": "Galaxy A73 5G",
            "SM-A1460": "Galaxy A14 5G",
            "SM-A2450": "Galaxy A24",
            "SM-A3460": "Galaxy A34 5G",
            "SM-A5460": "Galaxy A54 5G",
            "SM-A3560": "Galaxy A35 5G",
            "SM-A5560": "Galaxy A55 5G",
            "SM-A1660": "Galaxy A16",
            "IPHONE": "Apple iPhoneï¼ˆå‹è™ŸæœªçŸ¥ï¼‰",
            "PIXEL 7": "Google Pixel 7",
            "PIXEL 7 PRO": "Google Pixel 7 Pro",
            "PIXEL 8": "Google Pixel 8",
            "PIXEL 8 PRO": "Google Pixel 8 Pro",
            "PIXEL 9": "Google Pixel 9",
            "PIXEL 9 PRO": "Google Pixel 9 Pro",
            "ONEPLUS 9": "OnePlus 9",
            "ONEPLUS 10": "OnePlus 10",
            "ONEPLUS 11": "OnePlus Buds",
            "ONEPLUS 13": "OnePlus 13",
            "XQ-DC72": "Sony Xperia 1 V",
            "XQ-DQ72": "Sony Xperia 5 V",
            "23078PND5G": "Xiaomi 13T Pro",
            "22071212AG": "Xiaomi 12T Pro",
            "23021RAA2Y": "Redmi Note 12",
            "23090RA98G": "Redmi Note 13 Pro",
            "AI2205": "ASUS ROG Phone 6",
            "AI2401": "ASUS ROG Phone 8",
            "AI2302": "ASUS Zenfone 10",
            "CPH2491": "OPPO Reno10",
            "CPH2525": "OPPO Find X6",
            "V2238": "vivo X90",
            "V2303": "vivo Y78",
            "RMX3820": "realme 11 Pro+",
            "RMX3866": "realme GT Neo5"
        };

        function guessModelName(rawModel) {
            if (!rawModel) return rawModel || "æœªçŸ¥æ©Ÿå‹";
            const key = rawModel.toUpperCase();
            if (modelMap[key]) return modelMap[key];
            if (key.startsWith("SM-A")) return "Samsung Galaxy A ç³»åˆ— " + rawModel;
            if (key.startsWith("SM-S")) return "Samsung Galaxy S ç³»åˆ— " + rawModel;
            if (key.startsWith("SM-F")) return "Samsung Galaxy Z ç³»åˆ— " + rawModel;
            if (key.includes("IPHONE")) return "Apple iPhone";
            if (key.includes("PIXEL")) return rawModel;
            if (key.includes("ONEPLUS")) return rawModel;
            if (key.includes("OPPO")) return rawModel;
            if (key.includes("ASUS")) return rawModel;
            if (key.includes("VIVO")) return rawModel;
            if (key.includes("REALME")) return rawModel;
            if (key.includes("XIAOMI") || key.includes("REDMI")) return rawModel;
            return rawModel;
        }

        function detectBrand(modelCode) {
            const code = modelCode.toUpperCase();
            if (code.startsWith("SM-")) return "Samsung";
            if (code.includes("IPHONE")) return "Apple";
            if (code.includes("PIXEL")) return "Google";
            if (code.includes("ONEPLUS")) return "OnePlus";
            if (code.includes("OPPO")) return "OPPO";
            if (code.includes("ASUS")) return "ASUS";
            if (code.includes("VIVO")) return "vivo";
            if (code.includes("REALME")) return "realme";
            if (code.includes("XIAOMI") || code.includes("REDMI")) return "Xiaomi";
            return "Android";
        }

        function getAndroidModel(ua) {
            const regex = /android.*;\s([^;]+)\sbuild/i;
            let match = ua.match(regex);
            if (match && match[1]) {
                let model = match[1].trim();
                if (model.toLowerCase() === 'wv') {
                    return "Androidè£ç½®";
                }
                return model;
            }
            const regex2 = /android.*;\s([^;]+)\)/i;
            match = ua.match(regex2);
            if (match && match[1]) {
                let model = match[1].trim();
                if (model.toLowerCase() === 'wv') {
                    return "Androidè£ç½®";
                }
                return model;
            }
            return "Androidè£ç½®";
        }

        // ====== ä¿®æ­£: åœ¨é€™è£¡å‘¼å« getDeviceInfo å‡½å¼ ======
        function getDeviceInfo() {
            const ua = navigator.userAgent;
            if (ua.includes("iPhone")) {
                deviceBrand = "Apple";
                deviceModel = "iPhone";
            } else if (ua.includes("Android")) {
                const rawModel = getAndroidModel(ua);
                deviceModel = guessModelName(rawModel);
                deviceBrand = detectBrand(rawModel);
            }
        }

        // åˆå§‹åŒ– LIFF
        async function initLiff() {
            try {
                await liff.init({ liffId: LIFF_ID });
                if (!liff.isLoggedIn()) {
                    liff.login();
                } else {
                    const profile = await liff.getProfile();
                    userId = profile.userId || 'æœªçŸ¥';
                    // ä¿®æ­£: å‘¼å« getDeviceInfo ä¾†å–å¾—è£ç½®è³‡è¨Š
                    getDeviceInfo(); 
                    console.log(`ä½¿ç”¨è€…ID: ${userId}`);
                    console.log(`è£ç½®å“ç‰Œ: ${deviceBrand}, è£ç½®å‹è™Ÿ: ${deviceModel}`);
                }
            } catch (err) {
                console.error('LIFF åˆå§‹åŒ–å¤±æ•—', err);
                if (err.code === '2007597530') {
                    resultDiv.innerHTML = '<div class="notice">LIFF ID ç„¡æ•ˆï¼Œè«‹ç¢ºèªè¨­å®šã€‚</div>';
                }
            }
        }
        
        // ====== ä¿®æ­£: å‚³é€è³‡æ–™çµ¦ GAS ä¸¦å–å¾—çå“çµæœ ======
        async function sendData() {
            if (hasSentData) return;
            hasSentData = true;

            resultDiv.innerHTML = '<div class="loading-text">æ­£åœ¨ç¢ºèªä¸­ç...</div>';
            maskCanvas.style.pointerEvents = 'none';

            const params = new URLSearchParams({
                action: 'draw',
                deviceBrand,
                deviceModel,
                userId,
                timestamp: new Date().toISOString()
            });

            try {
                const res = await fetch(`${GAS_URL}?${params.toString()}`);
                const data = await res.json();
                console.log('GAS å›æ‡‰:', data);

                if (data.hasDrawn) {
                    resultDiv.innerHTML = `<div class="notice">ä½ å·²ç¶“åˆ®éå›‰ï¼</div>`;
                } else {
                    const prize = data.prize;
                    const images = {
                        'å¤©é¸çS1': 'https://i.postimg.cc/RCGKq4nk/6.png',
                        'å¤©é¸çS2': 'https://i.postimg.cc/gkxjRNkf/5.png',
                        'æ©Ÿæœƒç': 'https://i.postimg.cc/3xpwfNG1/3.png',
                        'å‘½é‹ç': 'https://i.postimg.cc/RFCV0TDp/2.png'
                    };

                    const img = new Image();
                    img.crossOrigin = 'anonymous';
                    img.src = images[prize] || 'https://placehold.co/1080x1350/999999/FFFFFF?text=éŒ¯èª¤';
                    
                    img.onload = () => {
                        setCanvasSize();
                        bgCtx.drawImage(img, 0, 0, bgCanvas.width, bgCanvas.height);
                        maskCanvas.style.opacity = '0'; // éš±è—é®ç½©
                        resultDiv.innerHTML = `<div class="prize">ğŸ‰ æ­å–œä½ ä¸­äº†ã€${prize}ã€‘ ğŸ‰</div><div class="notice">è«‹æ´½æœå‹™äººå“¡å…Œç</div>`;
                    };
                    img.onerror = () => {
                        resultDiv.innerHTML = `<div class="notice">åœ–ç‰‡è¼‰å…¥å¤±æ•—ï¼Œçé …ï¼š${prize}</div>`;
                    };
                }
            } catch (err) {
                console.error('é€å‡ºå¤±æ•—', err);
                resultDiv.innerHTML = '<div class="notice">è³‡æ–™é€å‡ºå¤±æ•—ï¼Œè«‹å†è©¦ä¸€æ¬¡ã€‚</div>';
            }
        }

        // ç•«å¸ƒå¤§å°è¨­å®š
        function setCanvasSize() {
            bgCanvas.width = maskCanvas.width = wrapper.clientWidth;
            bgCanvas.height = maskCanvas.height = wrapper.clientHeight;
        }

        // åˆå§‹åŒ–é®ç½©
        function initMask() {
            maskCtx.fillStyle = '#999';
            maskCtx.fillRect(0, 0, maskCanvas.width, maskCanvas.height);
        }

        // æª¢æŸ¥åˆ®é–‹æ¯”ä¾‹
        function checkScratchPercent() {
            const imgData = maskCtx.getImageData(0, 0, maskCanvas.width, maskCanvas.height).data;
            let cleared = 0;
            for (let i = 3; i < imgData.length; i += 4) {
                if (imgData[i] === 0) cleared++;
            }
            const percent = cleared / (maskCanvas.width * maskCanvas.height) * 100;
            if (percent > 50) {
                sendData();
            }
        }

        // ====== åˆ®åˆ®å¡äº‹ä»¶ ======
        let isDrawing = false;

        function getPos(e) {
            const rect = maskCanvas.getBoundingClientRect();
            if (e.touches?.length) {
                return { x: e.touches[0].clientX - rect.left, y: e.touches[0].clientY - rect.top };
            }
            return { x: e.clientX - rect.left, y: e.clientY - rect.top };
        }

        function scratch(e) {
            if (!isDrawing) return;
            e.preventDefault();
            const { x, y } = getPos(e);
            maskCtx.globalCompositeOperation = 'destination-out';
            maskCtx.beginPath();
            maskCtx.arc(x, y, 40, 0, Math.PI * 2);
            maskCtx.fill();
        }

        maskCanvas.addEventListener('mousedown', e => { isDrawing = true; scratch(e); });
        maskCanvas.addEventListener('mousemove', scratch);
        maskCanvas.addEventListener('mouseup', () => { isDrawing = false; checkScratchPercent(); });
        maskCanvas.addEventListener('mouseleave', () => { isDrawing = false; });

        maskCanvas.addEventListener('touchstart', e => { isDrawing = true; scratch(e); }, { passive: false });
        maskCanvas.addEventListener('touchmove', scratch, { passive: false });
        maskCanvas.addEventListener('touchend', () => { isDrawing = false; checkScratchPercent(); });

        // åˆå§‹åŒ–
        window.addEventListener('resize', () => {
            setCanvasSize();
            initMask(); // é‡æ–°ç¹ªè£½é®ç½©
        });

        window.onload = () => {
            setCanvasSize();
            initMask();
            initLiff();
        };
    </script>
</body>
</html>
