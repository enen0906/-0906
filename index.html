<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>ğŸŒŸå¤§å­¸æ˜Ÿç”Ÿæ´»ğŸŒŸåˆ®åˆ®å¡</title>
<style>
  body { margin:0; padding:0; font-family:Arial,sans-serif; background:#f8f8f8; text-align:center; }
  h1 { margin:15px 0; color:#333; font-size:clamp(20px,5vw,32px); }
  #wrapper { position:relative; display:inline-block; width:95vw; max-width:400px; margin:auto; }
  canvas { border:2px solid #ccc; border-radius:12px; display:block; width:100%; height:auto; }
  #result { margin-top:15px; font-size:clamp(16px,4vw,22px); color:#333; font-weight:bold; display:none; }
  .prize { font-size:clamp(24px,6vw,40px); font-weight:700; color:#c00; margin-bottom:6px; white-space:nowrap; }
  .notice { font-size:clamp(14px,3.5vw,18px); color:#e60000; font-weight:500; }
</style>
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</head>
<body>
<h1>ğŸŒŸå¤§å­¸æ˜Ÿç”Ÿæ´»ğŸŒŸ</h1>
<div id="wrapper">
  <canvas id="bgCanvas"></canvas>
  <canvas id="maskCanvas" style="position:absolute;top:0;left:0;"></canvas>
</div>
<div id="result">åˆ®é–‹çœ‹çœ‹ä½ çš„çé …ï¼</div>

<script>
const LIFF_ID = '2007597530-o1xaVbZm';
const GAS_URL = 'https://script.google.com/macros/s/AKfycbz9nfhw-DxaLUeSyMnmdvF02SjtlOLwccZ8--bFr_zqCgGJyCV4AYIe8fiUf0Vt1-tv/exec';

const wrapper = document.getElementById('wrapper');
const bgCanvas = document.getElementById('bgCanvas');
const maskCanvas = document.getElementById('maskCanvas');
const bgCtx = bgCanvas.getContext('2d');
const maskCtx = maskCanvas.getContext('2d');
const resultDiv = document.getElementById('result');

let deviceBrand='æœªçŸ¥', deviceModel='æœªçŸ¥', userId='æœªçŸ¥';
let prize='', hasSentData=false;

const images = {
  'å¤©é¸çS1':'https://i.postimg.cc/RCGKq4nk/6.png',
  'å¤©é¸çS2':'https://i.postimg.cc/gkxjRNkf/5.png',
  'æ©Ÿæœƒç':'https://i.postimg.cc/3xpwfNG1/3.png',
  'å‘½é‹ç':'https://i.postimg.cc/RFCV0TDp/2.png',
  'ç„¡çé …':'https://i.postimg.cc/3xpwfNG1/3.png'
};

// --- LIFF ç™»å…¥èˆ‡æŠ“ä½¿ç”¨è€… ID ---
async function initLiff(){
  await liff.init({liffId:LIFF_ID});
  if(!liff.isLoggedIn()) liff.login();
  else{
    try{ const profile=await liff.getProfile(); userId=profile.userId||'æœªçŸ¥'; } 
    catch(err){console.error('ç„¡æ³•å–å¾—ä½¿ç”¨è€…ID',err);}
    getDeviceInfo();
    await checkDrawStatus();
  }
}

function getDeviceInfo(){
  const ua=navigator.userAgent.toLowerCase();
  if(ua.includes('iphone')){ deviceBrand='Apple'; deviceModel='iPhone'; }
  else if(ua.includes('ipad')){ deviceBrand='Apple'; deviceModel='iPad'; }
  else if(ua.includes('android')){ deviceBrand='Android'; deviceModel='Androidè£ç½®'; }
  else{ deviceBrand='æœªçŸ¥'; deviceModel='æœªçŸ¥'; }
}

// --- æª¢æŸ¥æ˜¯å¦å·²æŠ½é ---
async function checkDrawStatus(){
  try{
    const resp = await fetch(`${GAS_URL}?action=check_draw&userId=${userId}`);
    const data = await resp.json();
    if(data.hasDrawn){
      prize='å·²æŠ½é';
      showResult('å·²æŠ½é');
    } else {
      prize=''; // ç­‰åˆ®å®Œå†æŠ½
    }
  } catch(e){
    console.error('æª¢æŸ¥æŠ½çç‹€æ…‹å¤±æ•—',e);
  }
}

// --- ç•«å¸ƒåˆå§‹åŒ– ---
function setCanvasSize(){
  const width = wrapper.clientWidth;
  const height = Math.floor(width*1350/1080);
  wrapper.style.height = height+'px';
  bgCanvas.width = maskCanvas.width = width;
  bgCanvas.height = maskCanvas.height = height;
}

function initMask(){
  maskCtx.fillStyle='#999';
  maskCtx.fillRect(0,0,maskCanvas.width,maskCanvas.height);
}

// --- åˆ®åˆ®å¡é‚è¼¯ ---
let isDrawing=false;
function getPos(e){
  const rect=maskCanvas.getBoundingClientRect();
  if(e.touches && e.touches.length>0) return {x:e.touches[0].clientX-rect.left, y:e.touches[0].clientY-rect.top};
  else return {x:e.clientX-rect.left, y:e.clientY-rect.top};
}

function scratch(e){
  if(!isDrawing) return;
  e.preventDefault();
  const {x,y}=getPos(e);
  maskCtx.globalCompositeOperation='destination-out';
  maskCtx.beginPath();
  maskCtx.arc(x,y,50,0,Math.PI*2);
  maskCtx.fill();
}

function checkScratchPercent(){
  const imgData=maskCtx.getImageData(0,0,maskCanvas.width,maskCanvas.height).data;
  let cleared=0;
  for(let i=3;i<imgData.length;i+=4) if(imgData[i]===0) cleared++;
  if(cleared/(maskCanvas.width*maskCanvas.height) > 0.5){
    if(!prize || prize===''){ // åˆ®å®Œæ‰æŠ½ç
      drawPrizeFromGAS();
    }
  }
}

// --- æŠ½ç ---
async function drawPrizeFromGAS(){
  try{
    const resp = await fetch(`${GAS_URL}?action=draw_prize&userId=${userId}`);
    const data = await resp.json();
    prize = data.prize || 'ç„¡çé …';
    const imgSrc = images[prize];
    const imgObj = new Image();
    imgObj.crossOrigin='anonymous';
    imgObj.onload = ()=>{
      bgCtx.clearRect(0,0,bgCanvas.width,bgCanvas.height);
      bgCtx.drawImage(imgObj,0,0,bgCanvas.width,bgCanvas.height);
      showResult(prize);
    };
    imgObj.src = imgSrc;
  } catch(e){
    console.error('æŠ½çå¤±æ•—',e);
    prize='ç„¡çé …';
    showResult(prize);
  }
}

// --- é¡¯ç¤ºçµæœ ---
function showResult(prizeText){
  resultDiv.innerHTML = `<div class="prize">ğŸ‰ ${prizeText==='å·²æŠ½é'?prizeText:`æ­å–œä½ ä¸­äº†ã€${prizeText}ã€‘`} ğŸ‰</div>
    <div class="notice">${prizeText==='å·²æŠ½é'?'':'è«‹æ´½æœå‹™äººå“¡å…Œç'}</div>`;
  resultDiv.style.display='block';
  maskCanvas.style.pointerEvents='none';
  if(prizeText!=='å·²æŠ½é') sendData(prizeText);
}

// --- é€è³‡æ–™åˆ° GAS ---
function sendData(prizeText){
  if(hasSentData) return;
  hasSentData=true;
  const params = new URLSearchParams({
    action:'record_win',
    prize:prizeText,
    deviceBrand,
    deviceModel,
    userId
  });
  fetch(GAS_URL,{method:'POST',body:params})
    .then(res=>res.json())
    .then(data=>console.log('è³‡æ–™å·²é€å‡º',data))
    .catch(e=>console.error(e));
}

// --- ç¶å®šäº‹ä»¶ ---
maskCanvas.addEventListener('mousedown',e=>{isDrawing=true;scratch(e);});
maskCanvas.addEventListener('mousemove',scratch);
maskCanvas.addEventListener('mouseup',()=>{isDrawing=false; checkScratchPercent();});
maskCanvas.addEventListener('mouseleave',()=>{isDrawing=false;});
maskCanvas.addEventListener('touchstart',e=>{isDrawing=true;scratch(e);},{passive:false});
maskCanvas.addEventListener('touchmove',scratch,{passive:false});
maskCanvas.addEventListener('touchend',()=>{isDrawing=false; checkScratchPercent();});

// --- åˆå§‹åŒ– ---
window.addEventListener('resize',()=>{
  setCanvasSize();
  if(prize && prize!=='å·²æŠ½é'){
    const imgObj = new Image();
    imgObj.src = images[prize];
    imgObj.onload = ()=> bgCtx.drawImage(imgObj,0,0,bgCanvas.width,bgCanvas.height);
  }
  initMask();
});

setCanvasSize();
initMask();
initLiff();
</script>
</body>
</html>
