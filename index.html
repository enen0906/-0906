<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>â­å¤§å­¸æ˜Ÿç”Ÿæ´»â­åˆ®åˆ®å¡</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            background: #fafafa;
            font-family: sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
        }

        h1 {
            font-size: 42px;
            color: #ff4500;
            font-weight: bold;
            margin: 20px 0;
            text-shadow: 1px 1px 2px #a00;
        }

        #scratch-card-container {
            position: relative;
            width: 90vw;
            max-width: 500px;
            aspect-ratio: 1080 / 1350;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        #prize-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }

        #scratch-mask {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #999;
            background-image: linear-gradient(135deg, #bbb 25%, #999 25%, #999 50%, #bbb 50%, #bbb 75%, #999 75%, #999 100%);
            background-size: 8px 8px;
            cursor: pointer;
            transition: opacity 0.3s ease-in-out;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 2em;
            color: white;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
            font-weight: bold;
        }

        #result {
            margin-top: 25px;
            text-align: center;
        }

        #result .prize-text {
            font-size: 48px;
            font-weight: 700;
            color: #c00;
        }

        #result .notice {
            font-size: 32px;
            color: #e60000;
            font-weight: 700;
        }

        .loading-text {
            font-size: 24px;
            color: #555;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% { opacity: 0.5; }
            50% { opacity: 1; }
            100% { opacity: 0.5; }
        }
    </style>
</head>
<body>
    <h1>â­å¤§å­¸æ˜Ÿç”Ÿæ´»â­</h1>
    <div id="scratch-card-container">
        <img id="prize-image" src="https://i.ibb.co/2d1rP3W/BG.png" alt="åˆ®åˆ®å¡èƒŒæ™¯" />
        <div id="scratch-mask">é»æˆ‘åˆ®é–‹</div>
    </div>
    <div id="result"></div>

    <script>
        // åœ¨é€™è£¡è¨­å®šä½ çš„ LIFF ID å’Œ Google Apps Script éƒ¨ç½²å¾Œçš„ URL
        const LIFF_ID = '2007597530-o1xaVbZm';
        const GAS_URL = 'https://script.google.com/macros/s/AKfycbz9nfhw-DxaLUeSyMnmdvF02SjtlOLwccZ8--F-zqCgGJyCV4AYIe8fiUf0Vt1-tv/exec';

        let hasSentData = false;
        let isScratching = false;

        const container = document.getElementById('scratch-card-container');
        const mask = document.getElementById('scratch-mask');
        const prizeImage = document.getElementById('prize-image');
        const resultDiv = document.getElementById('result');
        let userId = 'æœªçŸ¥';

        // è£ç½®è³‡è¨Š
        let deviceBrand = 'æœªçŸ¥';
        let deviceModel = 'æœªçŸ¥';

        // å‹è™Ÿå°ç…§è¡¨ (èˆ‡ä¹‹å‰çš„ç¨‹å¼ç¢¼ç›¸åŒ)
        const modelMap = {
            "SM-G9800": "Galaxy S20", "SM-G9860": "Galaxy S20+", "SM-G9880": "Galaxy S20 Ultra",
            "IPHONE": "Apple iPhoneï¼ˆå‹è™ŸæœªçŸ¥ï¼‰", "PIXEL 7": "Google Pixel 7"
        };
        function guessModelName(rawModel) {
            if (!rawModel) return rawModel || "æœªçŸ¥æ©Ÿå‹";
            const key = rawModel.toUpperCase();
            if (modelMap[key]) return modelMap[key];
            if (key.includes("IPHONE")) return "Apple iPhone";
            return rawModel;
        }
        function detectBrand(modelCode) {
            const code = modelCode.toUpperCase();
            if (code.startsWith("SM-")) return "Samsung";
            if (code.includes("IPHONE")) return "Apple";
            return "Android";
        }
        function getAndroidModel(ua) {
            const regex = /android.*;\s([^;]+)\sbuild/i;
            let match = ua.match(regex);
            if (match && match[1]) return match[1].trim();
            const regex2 = /android.*;\s([^;]+)\)/i;
            match = ua.match(regex2);
            if (match && match[1]) return match[1].trim();
            return "Androidè£ç½®";
        }
        function getDeviceInfo() {
            const ua = navigator.userAgent;
            if (ua.includes("iPhone")) { deviceBrand = "Apple"; deviceModel = "iPhone"; }
            else if (ua.includes("Android")) { const rawModel = getAndroidModel(ua); deviceModel = guessModelName(rawModel); deviceBrand = detectBrand(rawModel); }
        }

        function startApp() {
            console.log('LIFF åˆå§‹åŒ–æˆåŠŸï¼Œé–‹å§‹æ‡‰ç”¨ç¨‹å¼...');
            setupEventListeners();
        }

        // åˆå§‹åŒ– LIFF
        async function initLiff() {
            try {
                await liff.init({ liffId: LIFF_ID });
                if (!liff.isLoggedIn()) {
                    liff.login();
                } else {
                    const profile = await liff.getProfile();
                    userId = profile.userId || 'æœªçŸ¥';
                    getDeviceInfo();
                    startApp();
                }
            } catch (err) {
                console.error('LIFF åˆå§‹åŒ–å¤±æ•—', err);
                resultDiv.innerHTML = '<div class="notice">LIFF åˆå§‹åŒ–å¤±æ•—ï¼Œè«‹ç¢ºèª LIFF IDã€‚</div>';
            }
        }

        // å‘ Google Apps Script å‚³é€æŠ½çè³‡æ–™
        async function sendData() {
            if (hasSentData) return;
            hasSentData = true;

            resultDiv.innerHTML = '<div class="loading-text">æ­£åœ¨ç¢ºèªä¸­ç...</div>';
            mask.textContent = 'ä¸­çç¢ºèªä¸­...';

            const params = new URLSearchParams({
                action: 'draw',
                deviceBrand,
                deviceModel,
                userId,
                timestamp: new Date().toISOString()
            });

            try {
                const res = await fetch(`${GAS_URL}?${params.toString()}`);
                const data = await res.json();
                console.log('GAS å›æ‡‰:', data);

                if (data.hasDrawn) {
                    resultDiv.innerHTML = `<div class="notice">ä½ å·²ç¶“åˆ®éå›‰ï¼</div>`;
                    // ç‚ºäº†é¿å…é‡è¤‡é¡¯ç¤ºï¼Œé€™è£¡å¯ä»¥é¸æ“‡ä¸æ›¿æ›åœ–ç‰‡ï¼Œæˆ–è€…ç”¨ä¸€å€‹é è¨­çš„ã€Œå·²åˆ®éã€åœ–ç‰‡
                    prizeImage.src = 'https://i.ibb.co/2d1rP3W/BG.png';
                    mask.style.opacity = '0';
                    mask.style.display = 'none';
                } else {
                    const prize = data.prize;
                    const images = {
                        'å¤©é¸çS1': 'https://i.ibb.co/L5hY52B/S1-prize.jpg',
                        'å¤©é¸çS2': 'https://i.ibb.co/6PzL2nF/S2-prize.jpg',
                        'æ©Ÿæœƒç': 'https://i.ibb.co/6Pq931P/A.png',
                        'å‘½é‹ç': 'https://i.ibb.co/YyLgT7c/B.png'
                    };

                    const imgUrl = images[prize] || 'https://placehold.co/1080x1350/999999/FFFFFF?text=éŒ¯èª¤';
                    
                    // æ›¿æ›èƒŒæ™¯åœ–ç‰‡ä¸¦ç§»é™¤é®ç½©
                    prizeImage.src = imgUrl;
                    mask.style.opacity = '0';
                    mask.style.display = 'none';
                    resultDiv.innerHTML = `<div class="prize-text">ğŸ‰ æ­å–œä½ ä¸­äº†ã€${prize}ã€‘ ğŸ‰</div><div class="notice">è«‹æ´½æœå‹™äººå“¡å…Œç</div>`;
                }
            } catch (err) {
                console.error('è³‡æ–™é€å‡ºå¤±æ•—', err);
                resultDiv.innerHTML = '<div class="notice">è³‡æ–™é€å‡ºå¤±æ•—ï¼Œè«‹å†è©¦ä¸€æ¬¡ã€‚</div>';
                mask.style.opacity = '1';
                mask.textContent = 'é»æˆ‘åˆ®é–‹';
                hasSentData = false;
            }
        }

        // åˆ®åˆ®å¡äº’å‹•é‚è¼¯
        function scratch(e) {
            if (hasSentData) return;
            e.preventDefault();
            
            // ç”±æ–¼æ²’æœ‰ Canvasï¼Œæˆ‘å€‘ç›´æ¥éš±è—é®ç½©
            mask.style.opacity = '0';
            sendData();
            isScratching = false; // åˆ®ä¸€æ¬¡å¾Œå°±åœæ­¢
        }

        function setupEventListeners() {
            mask.addEventListener('mousedown', () => { isScratching = true; });
            mask.addEventListener('mouseup', () => { isScratching = false; });
            mask.addEventListener('mousemove', scratch);

            mask.addEventListener('touchstart', () => { isScratching = true; }, { passive: false });
            mask.addEventListener('touchend', () => { isScratching = false; });
            mask.addEventListener('touchmove', scratch, { passive: false });
        }

        window.addEventListener('DOMContentLoaded', () => {
            initLiff();
        });
    </script>
</body>
</html>
